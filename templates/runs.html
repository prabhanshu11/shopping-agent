{% extends "base.html" %}

{% block content %}
<div class="runs-page">
    <!-- Filter Bar -->
    <div class="card">
        <div class="filter-bar">
            <select id="status-filter">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="running">Running</option>
                <option value="success">Success</option>
                <option value="failed">Failed</option>
            </select>
            <select id="platform-filter">
                <option value="">All Platforms</option>
                <option value="amazon">Amazon</option>
                <option value="swiggy">Swiggy</option>
                <option value="blinkit">Blinkit</option>
            </select>
            <button class="btn btn-secondary" onclick="loadRuns()">Refresh</button>
            <label style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="auto-refresh" checked>
                Auto-refresh
            </label>
        </div>
    </div>

    <!-- Runs List -->
    <div id="runs-list" class="runs-list">
        <div class="loading">Loading runs...</div>
    </div>

    <!-- Run Detail Modal -->
    <div id="run-detail-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="modal-run-name">Run Details</h3>
                <button class="btn btn-secondary btn-small" onclick="closeModal()">Close</button>
            </div>
            <div id="modal-run-content">
                <!-- Populated by JS using safe DOM methods -->
            </div>
        </div>
    </div>

    <!-- Screenshot Lightbox -->
    <div id="lightbox" class="lightbox hidden" onclick="closeLightbox()">
        <img id="lightbox-img" src="" alt="Screenshot">
    </div>
</div>

<style>
/* Runs Page Specific Styles */
.runs-list {
    display: grid;
    gap: 15px;
}

.run-card {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
}

.run-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
}

.run-card.running {
    border-left: 4px solid var(--warning);
}

.run-card.success {
    border-left: 4px solid var(--success);
}

.run-card.failed {
    border-left: 4px solid var(--danger);
}

.run-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.run-header h4 {
    font-size: 1.1rem;
}

.run-meta {
    display: flex;
    gap: 15px;
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.run-meta span {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Status Badges */
.status-badge.pending {
    background: rgba(170, 170, 170, 0.2);
    color: var(--text-secondary);
}

.status-badge.running {
    background: rgba(255, 193, 7, 0.2);
    color: var(--warning);
    animation: pulse 1.5s infinite;
}

.status-badge.success {
    background: rgba(78, 204, 163, 0.2);
    color: var(--success);
}

.status-badge.failed {
    background: rgba(233, 69, 96, 0.2);
    color: var(--danger);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* Modal Styles */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border);
}

.run-detail {
    margin-bottom: 20px;
}

.run-detail .info-row {
    display: flex;
    gap: 20px;
    margin-bottom: 10px;
}

.run-detail .info-item {
    display: flex;
    flex-direction: column;
}

.run-detail .info-item label {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.run-detail .info-item span {
    font-size: 0.95rem;
}

.error-box {
    background: rgba(233, 69, 96, 0.1);
    border: 1px solid var(--danger);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.error-box h5 {
    color: var(--danger);
    margin-bottom: 5px;
}

.error-box pre {
    font-size: 0.85rem;
    color: var(--text-secondary);
    white-space: pre-wrap;
}

/* Steps Timeline */
.steps-timeline {
    position: relative;
    padding-left: 30px;
}

.steps-timeline::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--border);
}

.step-item {
    position: relative;
    margin-bottom: 20px;
    padding: 15px;
    background: var(--bg-card);
    border-radius: 8px;
    border: 1px solid var(--border);
}

.step-item::before {
    content: '';
    position: absolute;
    left: -24px;
    top: 20px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--bg-secondary);
    border: 2px solid var(--border);
}

.step-item.success::before {
    background: var(--success);
    border-color: var(--success);
}

.step-item.failed::before {
    background: var(--danger);
    border-color: var(--danger);
}

.step-item.running::before {
    background: var(--warning);
    border-color: var(--warning);
    animation: pulse 1s infinite;
}

.step-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.step-header h5 {
    font-size: 1rem;
}

.step-meta {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.step-error {
    background: rgba(233, 69, 96, 0.1);
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    font-size: 0.85rem;
    color: var(--danger);
}

.step-screenshot {
    margin-top: 15px;
}

.step-screenshot img {
    max-width: 100%;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid var(--border);
    transition: opacity 0.2s;
}

.step-screenshot img:hover {
    opacity: 0.8;
}

/* Lightbox */
.lightbox {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    cursor: zoom-out;
}

.lightbox.hidden {
    display: none;
}

.lightbox img {
    max-width: 95%;
    max-height: 95%;
    border-radius: 8px;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.empty-state h4 {
    margin-bottom: 10px;
    color: var(--text-primary);
}
</style>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshInterval = null;

async function loadRuns() {
    const statusFilter = document.getElementById('status-filter').value;
    const platformFilter = document.getElementById('platform-filter').value;

    let url = '/api/runs?limit=50';
    if (statusFilter) url += '&status=' + encodeURIComponent(statusFilter);
    if (platformFilter) url += '&platform=' + encodeURIComponent(platformFilter);

    try {
        const response = await fetch(url);
        const data = await response.json();
        renderRuns(data.runs);
    } catch (error) {
        console.error('Failed to load runs:', error);
        const container = document.getElementById('runs-list');
        container.textContent = '';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = 'Failed to load runs. Is the server running?';
        container.appendChild(errorDiv);
    }
}

function renderRuns(runs) {
    const container = document.getElementById('runs-list');
    container.textContent = '';

    if (!runs || runs.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        const h4 = document.createElement('h4');
        h4.textContent = 'No agent runs yet';
        const p = document.createElement('p');
        p.textContent = 'Runs will appear here when you execute agent tasks.';
        emptyState.appendChild(h4);
        emptyState.appendChild(p);
        container.appendChild(emptyState);
        return;
    }

    runs.forEach(run => {
        const card = document.createElement('div');
        card.className = 'run-card ' + run.status;
        card.onclick = () => showRunDetail(run.id);

        const header = document.createElement('div');
        header.className = 'run-header';

        const h4 = document.createElement('h4');
        h4.textContent = run.name;

        const badge = document.createElement('span');
        badge.className = 'status-badge ' + run.status;
        badge.textContent = run.status.toUpperCase();

        header.appendChild(h4);
        header.appendChild(badge);
        card.appendChild(header);

        const meta = document.createElement('div');
        meta.className = 'run-meta';

        const platformSpan = document.createElement('span');
        platformSpan.textContent = 'Platform: ' + run.platform;
        meta.appendChild(platformSpan);

        const stepsSpan = document.createElement('span');
        stepsSpan.textContent = 'Steps: ' + (run.step_count || 0);
        meta.appendChild(stepsSpan);

        if (run.duration_ms) {
            const durationSpan = document.createElement('span');
            durationSpan.textContent = 'Duration: ' + formatDuration(run.duration_ms);
            meta.appendChild(durationSpan);
        }

        if (run.started_at) {
            const startedSpan = document.createElement('span');
            startedSpan.textContent = 'Started: ' + formatTime(run.started_at);
            meta.appendChild(startedSpan);
        }

        card.appendChild(meta);

        if (run.error_message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'step-error';
            errorDiv.textContent = run.error_message;
            card.appendChild(errorDiv);
        }

        container.appendChild(card);
    });
}

async function showRunDetail(runId) {
    try {
        const response = await fetch('/api/runs/' + runId);
        const run = await response.json();
        renderRunDetail(run);
        document.getElementById('run-detail-modal').classList.remove('hidden');
    } catch (error) {
        console.error('Failed to load run detail:', error);
    }
}

function renderRunDetail(run) {
    document.getElementById('modal-run-name').textContent = run.name;

    const content = document.getElementById('modal-run-content');
    content.textContent = '';

    // Run info section
    const runDetail = document.createElement('div');
    runDetail.className = 'run-detail';

    const infoRow = document.createElement('div');
    infoRow.className = 'info-row';

    // Platform
    const platformItem = createInfoItem('Platform', run.platform);
    infoRow.appendChild(platformItem);

    // Status
    const statusItem = document.createElement('div');
    statusItem.className = 'info-item';
    const statusLabel = document.createElement('label');
    statusLabel.textContent = 'Status';
    const statusBadge = document.createElement('span');
    statusBadge.className = 'status-badge ' + run.status;
    statusBadge.textContent = run.status.toUpperCase();
    statusItem.appendChild(statusLabel);
    statusItem.appendChild(statusBadge);
    infoRow.appendChild(statusItem);

    // Duration
    const durationItem = createInfoItem('Duration', run.duration_ms ? formatDuration(run.duration_ms) : 'N/A');
    infoRow.appendChild(durationItem);

    // Steps count
    const stepsItem = createInfoItem('Steps', String(run.steps.length));
    infoRow.appendChild(stepsItem);

    runDetail.appendChild(infoRow);

    if (run.description) {
        const descP = document.createElement('p');
        descP.className = 'step-meta';
        descP.textContent = run.description;
        runDetail.appendChild(descP);
    }

    content.appendChild(runDetail);

    // Error box if present
    if (run.error_message) {
        const errorBox = document.createElement('div');
        errorBox.className = 'error-box';
        const errorH5 = document.createElement('h5');
        errorH5.textContent = 'Error';
        const errorPre = document.createElement('pre');
        errorPre.textContent = run.error_message;
        errorBox.appendChild(errorH5);
        errorBox.appendChild(errorPre);
        content.appendChild(errorBox);
    }

    // Steps header
    const stepsHeader = document.createElement('h4');
    stepsHeader.style.marginBottom = '15px';
    stepsHeader.textContent = 'Steps';
    content.appendChild(stepsHeader);

    // Steps timeline
    const timeline = document.createElement('div');
    timeline.className = 'steps-timeline';

    if (run.steps.length === 0) {
        const emptyP = document.createElement('p');
        emptyP.className = 'empty';
        emptyP.textContent = 'No steps recorded';
        timeline.appendChild(emptyP);
    } else {
        run.steps.forEach(step => {
            const stepItem = document.createElement('div');
            stepItem.className = 'step-item ' + step.status;

            const stepHeader = document.createElement('div');
            stepHeader.className = 'step-header';

            const stepH5 = document.createElement('h5');
            stepH5.textContent = step.name;

            const stepBadge = document.createElement('span');
            stepBadge.className = 'status-badge ' + step.status;
            stepBadge.textContent = step.status.toUpperCase();

            stepHeader.appendChild(stepH5);
            stepHeader.appendChild(stepBadge);
            stepItem.appendChild(stepHeader);

            if (step.description) {
                const descP = document.createElement('p');
                descP.className = 'step-meta';
                descP.textContent = step.description;
                stepItem.appendChild(descP);
            }

            const stepMeta = document.createElement('div');
            stepMeta.className = 'step-meta';
            let metaText = '';
            if (step.duration_ms) metaText += 'Duration: ' + formatDuration(step.duration_ms);
            if (step.started_at) metaText += (metaText ? ' | ' : '') + 'Started: ' + formatTime(step.started_at);
            stepMeta.textContent = metaText;
            stepItem.appendChild(stepMeta);

            if (step.error_message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'step-error';
                errorDiv.textContent = step.error_message;
                stepItem.appendChild(errorDiv);
            }

            if (step.screenshot_path) {
                const screenshotDiv = document.createElement('div');
                screenshotDiv.className = 'step-screenshot';
                const img = document.createElement('img');
                img.src = step.screenshot_path;
                img.alt = 'Screenshot';
                img.onclick = (e) => {
                    e.stopPropagation();
                    openLightbox(step.screenshot_path);
                };
                screenshotDiv.appendChild(img);
                stepItem.appendChild(screenshotDiv);
            }

            timeline.appendChild(stepItem);
        });
    }

    content.appendChild(timeline);
}

function createInfoItem(labelText, valueText) {
    const item = document.createElement('div');
    item.className = 'info-item';
    const label = document.createElement('label');
    label.textContent = labelText;
    const value = document.createElement('span');
    value.textContent = valueText;
    item.appendChild(label);
    item.appendChild(value);
    return item;
}

function closeModal() {
    document.getElementById('run-detail-modal').classList.add('hidden');
}

function openLightbox(src) {
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').classList.remove('hidden');
}

function closeLightbox() {
    document.getElementById('lightbox').classList.add('hidden');
}

function formatDuration(ms) {
    if (ms < 1000) return ms + 'ms';
    if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
    return (ms / 60000).toFixed(1) + 'm';
}

function formatTime(isoString) {
    const date = new Date(isoString);
    return date.toLocaleTimeString();
}

function setupAutoRefresh() {
    const checkbox = document.getElementById('auto-refresh');

    checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
            autoRefreshInterval = setInterval(loadRuns, 3000);
        } else {
            clearInterval(autoRefreshInterval);
        }
    });

    // Start auto-refresh by default
    autoRefreshInterval = setInterval(loadRuns, 3000);
}

// Event listeners
document.getElementById('status-filter').addEventListener('change', loadRuns);
document.getElementById('platform-filter').addEventListener('change', loadRuns);

// Close modal on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeModal();
        closeLightbox();
    }
});

// Initial load
loadRuns();
setupAutoRefresh();
</script>
{% endblock %}
